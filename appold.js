"use strict";function onNotification(e){console.log("Received push notification: "+JSON.stringify(e));var t=angular.element(document.body).injector().get("AppService");t.pushNotificationReceived(),"message"==e.type?t.newMessageNotification(e.message):"match"==e.type?t.newMatchNotification(e.matchId):"removeMatch"==e.type&&t.removeMatchNotification(e.matchId)}function onNotificationOpen(e){console.log("Opened push notification: "+JSON.stringify(e));var t=(angular.element(document.body).injector().get("AppService"),angular.element(document.body).injector().get("$state"));"message"==e.type?(console.log("going to menu.chat "+e.message.match.id),t.go("menu.chat",{matchId:e.message.match.id})):"match"==e.type&&(console.log("going to menu.match-profile "+e.matchId),t.go("menu.match-profile",{matchId:e.matchId}))}function enhance(e,t){for(var n=0;n<t.length;n++)!function(){var o=t[n],r=e;Object.defineProperty(r,o,{get:function(){return this.get(o)},set:function(e){this.set(o,e)}})}()}function getDistanceFromLatLonInKm(e,t,n,o){var r=6371,i=deg2rad(n-e),a=deg2rad(o-t),c=Math.sin(i/2)*Math.sin(i/2)+Math.cos(deg2rad(e))*Math.cos(deg2rad(n))*Math.sin(a/2)*Math.sin(a/2),s=2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)),l=r*s;return l}function deg2rad(e){return e*(Math.PI/180)}angular.module("ngCordova.plugins.socialSharing",[]).factory("$cordovaSocialSharing",["$q","$window",function(e,t){return{share:function(n,o,r,i){if(!t.plugins||!t.plugins.socialsharing)return e.reject("socialsharing plugin not found");var a=e.defer();return o=o||null,r=r||null,i=i||null,t.plugins.socialsharing.share(n,o,r,i,function(){a.resolve(!0)},function(){a.reject(!1)}),a.promise},shareViaTwitter:function(n,o,r){var i=e.defer();return o=o||null,r=r||null,t.plugins.socialsharing.shareViaTwitter(n,o,r,function(){i.resolve(!0)},function(){i.reject(!1)}),i.promise},shareViaWhatsApp:function(n,o,r){var i=e.defer();return o=o||null,r=r||null,t.plugins.socialsharing.shareViaWhatsApp(n,o,r,function(){i.resolve(!0)},function(){i.reject(!1)}),i.promise},shareViaFacebook:function(n,o,r){var i=e.defer();return n=n||null,o=o||null,r=r||null,t.plugins.socialsharing.shareViaFacebook(n,o,r,function(){i.resolve(!0)},function(){i.reject(!1)}),i.promise},shareViaFacebookWithPasteMessageHint:function(n,o,r,i){var a=e.defer();return o=o||null,r=r||null,t.plugins.socialsharing.shareViaFacebookWithPasteMessageHint(n,o,r,i,function(){a.resolve(!0)},function(){a.reject(!1)}),a.promise},shareViaSMS:function(n,o){var r=e.defer();return t.plugins.socialsharing.shareViaSMS(n,o,function(){r.resolve(!0)},function(){r.reject(!1)}),r.promise},shareViaEmail:function(n,o,r,i,a,c){var s=e.defer();return r=r||null,i=i||null,a=a||null,c=c||null,t.plugins.socialsharing.shareViaEmail(n,o,r,i,a,c,function(){s.resolve(!0)},function(){s.reject(!1)}),s.promise},shareVia:function(n,o,r,i,a){var c=e.defer();return o=o||null,r=r||null,i=i||null,a=a||null,t.plugins.socialsharing.shareVia(n,o,r,i,a,function(){c.resolve(!0)},function(){c.reject(!1)}),c.promise},canShareViaEmail:function(){var n=e.defer();return t.plugins.socialsharing.canShareViaEmail(function(){n.resolve(!0)},function(){n.reject(!1)}),n.promise},canShareVia:function(n,o,r,i,a){var c=e.defer();return t.plugins.socialsharing.canShareVia(n,o,r,i,a,function(e){c.resolve(e)},function(e){c.reject(e)}),c.promise},available:function(){var t=e.defer();window.plugins.socialsharing.available(function(e){e?t.resolve():t.reject()})}}}]);var TRANSLATION_EN={OK:"Ok",SAVE:"Save",SEND:"Send",CANCEL:"Cancel",LOADING:"Loading",REMOVE:"Remove",REPORT:"Report",LOGOUT:"Logout",PASSWORD_RESET_SENT:"Password reset link emailed",PASSWORD_LENGTH:"Password must be at least 6 characters",INVALID_EMAIL:"Enter a valid email",LOGGING_IN_TO_FB:"Logging into Facebook",LOGGING_IN_TO_LINKEDIN:"Logging into LinkedIn",LOADING_PROFILE:"Loading profile",LOADING_FB_PROFILE:"Loading Facebook profile",CREATING_ACCOUNT:"Creating account",WAITING_FOR_GPS:"Waiting for GPS location",LOGIN_ERROR:"Error logging in. Try again later",VERIFY_EMAIL_MESSAGE:"Check your inbox for an email to verify your address, then come back and click the button below",CHECK_EMAIL_VERIFICATION:"Check Email Verification",EMAIL_NOT_VERIFIED:"Email is not verified",FIRST_NAME_REQUIRED:"First name is required",SURNAME_REQUIRED:"Surname is required",BIRTH_MONTH_REQUIRED:"Birth month is required",BIRTH_YEAR_REQUIRED:"Birth year is required",GENDER_REQUIRED:"Gender is required",TERMS_OF_USE:"Terms of Use",MENU_PROFILE:"Profile",MENU_MATCHES:"Find Matches",MENU_CHAT:"Chat",MENU_DISCOVERY:"Discovery Preferences",MENU_SETTINGS:"App Settings",MENU_CONTACT:"Contact Us",MENU_SHARE:"Share",PROFILE_SETUP_MSG:"We need a couple more details",BIRTH_MONTH:"Birth month",BIRTH_YEAR:"Birth year",FIRST_NAME:"First name",GENDER:"Gender",MALE:"Male",FEMALE:"Female",PROFILE_TITLE:"My Profile",ABOUT:"About",FRIENDS_USING:"My Friends",MY_INTERESTS:"My Interests",EDIT_PROFILE_TITLE:"Edit Profile",ABOUT_YOU:"About You",AWAY:"away",ALBUMS:"Albums",NO_FB_ALBUMS:"You don't have any Facebook albums",ADD_A_PHOTO:"Add a photo",CROP_YOUR_PHOTO:"Crop your photo",DISCOVERY_TITLE:"Discovery Preferences",DISCOVERABLE:"Discoverable",SHOW_ME:"Show me",GUYS:"Guys",GIRLS:"Girls",SEARCH_DISTANCE:"Search distance",AGED_BETWEEN:"Aged between",SETTINGS_TITLE:"App Settings",NOTIFICATION_SOUND:"Notification Sound",NEW_MATCH:"New match",NEW_MESSAGE:"New message",SHOW_DISTANCES_IN:"Show distances in",NOT_DISCOVERABLE:"You're not discoverable",ENABLE_DISCOVERY_TO_MEET:"Enable discovery to meet new people nearby",ENABLE_DISCOVERY:"Enable Discovery",FINDING_PEOPLE:"Finding people near you",NO_ONE_NEW:"There's no one new around you",SEARCH_AGAIN:"Search Again",LIKE:"Like",NOT_LIKE:"Nope",LOCATION:"Location",SET_LOCATION:"Set Location",USE_GPS_LOCATION:"Use GPS location",GPS_ERROR:"Unable to get GPS location",SET_MAP_LOCATION:"Please set your location on the map and press save",NO_MATCHES:"You don't have any matches yet.",START_SWIPING:"Start swiping",MATCHES_LOAD_ERROR:"Unable to load matches",ITS_A_MATCH:"It's A Match",LIKED_EACH_OTHER:"You and {{name}} have liked each other",SEND_MESSAGE:"Send Message",KEEP_PLAYING:"Keep Playing",REMOVE_MATCH:"Remove match",MATCH_OPTIONS:"Match options",REMOVE_MATCH_ERROR:"Error removing match. Try again later",UNMATCHED:"You were unmatched",MATCH_REPORTED:"Match reported",WANT_TO_REMOVE_MATCH:"Do you want to remove this match?",TYPE_YOUR_MESSAGE:"Type your message",MESSAGE_NOT_SENT:"Message not sent. Try again",SETTINGS_SAVE_ERROR:"Error saving settings. Try again later",REQUEST_FAILED:"Request failed",DELETE:"Delete",DELETE_ACCOUNT:"Delete your account","":""},TRANSLATION_DE={LOGGING_IN_TO_FB:"Anmelden bei Facebook",LOADING_PROFILE:"Laden profil"};!function(){angular.module("service.app",["ngCordova","service.parse","service.localdb"]).factory("AppService",["$rootScope","$timeout","$http","$cordovaFacebook","$cordovaGeolocation","$cordovaMedia","$log","$state","$q","$ionicHistory","ParseService","LocalDB","$localStorage","$interval","$analytics",function(e,t,n,o,r,i,a,c,s,l,u,d,f,h,g){function p(){d.init().then(function(){return d.getMatches()}).then(function(e){var t=!0,n=!1,o=void 0;try{for(var r,i=e[Symbol.iterator]();!(t=(r=i.next()).done);t=!0){var a=r.value;ge.push(a),ve[a.profile.id]=a.profile}}catch(c){n=!0,o=c}finally{try{!t&&i["return"]&&i["return"]()}finally{if(n)throw o}}},function(e){return a.error("Error loading db matches "+JSON.stringify(e))}),he.init()}function m(e){return g.eventTrack("facebookLogin"),he.facebookLogin(e).then(function(e){return Ae.userId=he.getUserId(),e})}function v(e){return g.eventTrack("linkedInLogin"),he.linkedInLogin(e).then(function(e){return Ae.userId=e.id,s.when(e)})}function E(e,t){return g.eventTrack("signupEmail"),he.signUp(e,t).then(function(e){return Ae.userId=he.getUserId(),e})}function S(e,t){return g.eventTrack("loginEmail"),he.logIn(e,t).then(function(e){return Ae.userId=he.getUserId(),e})}function P(){he.autoLogin()}function M(){return he.reloadUser()}function T(){return he.reloadUser().then(function(e){return e.emailVerified===!0})}function y(){return f.termsOfUseAgreed=!0,s.when()}function A(e){return g.eventTrack("passwordReset"),he.requestPasswordReset(e)}function b(){return Ae.profile?s.when(Ae.profile):he.getProfile().then(function(e){return _.isUndefined(e.gps)&&(e.gps=!0),console.log("AppService server.getProfile returned "+e),Ae.profile=e,Ae.profile})}function C(){return Ae.profile}function I(e){a.debug("getProfileByMatchId "+e);var t=ge[e];if(t){var n=ve[t.profileId];if(n)return s.when(n)}return he.getProfileForMatch(e).then(function(e){return ve[e.id]=e,e})}function R(e){return ve[e]}function w(){var t=Parse.User.current();return e.facebookConnected||t.emailVerified!==!1?$()?C().location?f.termsOfUseAgreed?(N(),void O("menu.home")):void O("termsOfUse"):void O("locationSetup"):void O("profileSetup"):void O("emailVerification")}function O(e){l.nextViewOptions({historyRoot:!0,disableBack:!0}),c.go(e)}function N(){var e=function(){++Te===Me?(Te=0,Q().always(z)):z()};Q().always(z),ye||f.pushNotificationReceived||(a.log("Starting polling synchronization"),ye=h(e,Pe))}function $(){return Ae.profile.birthdate&&Ae.profile.name&&Ae.profile.gender}function L(){console.log("getCurrentPosition()");var e=1e4,n=s.defer(),o=function(){console.log("$cordovaGeolocation.getCurrentPosition did not return within the timeout"),n.reject("GEO_ERROR")},i=t(o,e+1e3);return r.getCurrentPosition().then(function(e){t.cancel(i),console.log("location "+JSON.stringify(e));var o=he.convertLocation(e.coords.latitude,e.coords.longitude);n.resolve(o)},function(e){t.cancel(i),console.log("getCurrentPosition error: "+JSON.stringify(e)),n.reject("GEO_ERROR")},{maximumAge:36e5,timeout:e,enableHighAccuracy:!0}),n.promise}function U(e){var t={notifyMatch:e.notifyMatch,notifyMessage:e.notifyMessage,distanceType:e.distanceType};return he.saveSettings(Ae.profile,t).then(function(e){return console.log("saveSettings result:"+JSON.stringify(e)),Ae.profile})}function D(){return he.copyFacebookProfile().then(function(e){return Ae.profile=e,Ae.profile})}function k(){return F({enabled:!0})}function F(e){return console.log("saving profile"),he.saveProfile(Ae.profile,e).then(function(e){return Ae.profile})}function G(){g.eventTrack("logout"),Ae.userId=null,Ae.fbId=null,Ae.profile=null,ge=[],ve=[],Ee=null,Se=null,pe={},me=0,ye&&(h.cancel(ye),ye=null),he.logout(),localStorage.clear(),f.$reset(),d.deleteDb(),e.facebookConnected&&(console.log("logging out of Facebook"),o.logout().then(function(t){console.log("logged out of facebook"),delete e.facebookConnected,delete e.fbAccessToken},function(e){console.log("error logging out of Facebook "+JSON.stringify(e))})),l.clearCache(),l.nextViewOptions({disableBack:!0}),c.go("signin")}function V(){return g.eventTrack("deleteAccount"),he.deleteAccount()}function x(){return he.deleteUnmatched()}function B(t,n){return g.eventTrack("swipe",{liked:n?"true":"false"}),he.processProfile(t,n).then(function(t){console.log("processed match action"),null!=t&&"M"==t.state&&I(t.id).then(function(n){t.profile=n,ge.push(t),d.saveMatch(t,n),e.$broadcast("newMatch",t)})},function(e){console.log("error processing match "+JSON.stringify(e))})}function H(e){Q().then(function(e){if(e.length&&Ae.profile.notifyMatch){var t=new Media(ue("audio/match-notification.mp3"),null,null,null);i.play(t)}})}function j(e){return g.eventTrack("removeMatch"),console.log("removeMatch "+e),he.removeMatch(e).then(function(t){d.deleteMatch(e),_.remove(ge,{id:e})})}function J(t){console.log("removeMatchNotification "+t),ge&&_.remove(ge,{id:t}),Ee==t&&(Ee=null,Se=null,console.log("cleared active chat from remove notification")),d.deleteMatch(t),e.$broadcast("matchRemoved",t)}function q(){return Ae.potentialMatches}function W(){return g.eventTrack("searchProfiles"),he.searchProfiles(Ae.profile).then(function(t){return Ae.potentialMatches=t,e.$broadcast("newPotentialMatches"),Ae.potentialMatches})}function Y(){Ae.potentialMatches=null}function K(){return console.log("getMutualMatches()"),null!=ge?ge:(ge=[],d.getMatches().then(function(e){var t=!0,n=!1,o=void 0;try{for(var r,i=e[Symbol.iterator]();!(t=(r=i.next()).done);t=!0){var a=r.value;ge.push(a),ve[a.profile.id]=a.profile}}catch(c){n=!0,o=c}finally{try{!t&&i["return"]&&i["return"]()}finally{if(n)throw o}}return Q(),ge}))}function Q(){return a.debug("synchronizeMutualMatches()"),he.reloadUser().then(function(e){var t=_.pluck(ge,"id"),n=e.matches,o=_.difference(t,n),r=_.difference(n,t);a.debug("Found "+o.length+" mutual matches to remove"),a.debug("Found "+r.length+" mutual matches to add");var i=!0,c=!1,s=void 0;try{for(var l,u=o[Symbol.iterator]();!(i=(l=u.next()).done);i=!0){var d=l.value;J(d)}}catch(f){c=!0,s=f}finally{try{!i&&u["return"]&&u["return"]()}finally{if(c)throw s}}return he.getMatches(r)}).then(function(e){a.debug("loaded "+e.length+" matches to sync");var t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],n=!0,o=!1,r=void 0;try{for(var i,c=e[Symbol.iterator]();!(n=(i=c.next()).done);n=!0){var s=i.value;a.debug("syncing new match "+s.id);var l=new Date(s.createdAt),u=l.getDate()+" "+t[l.getMonth()];s.lastMessage="Matched on "+u,ge.unshift(s);var f=s.profile;d.saveMatch(s,f),ve[f.id]=f}}catch(h){o=!0,r=h}finally{try{!n&&c["return"]&&c["return"]()}finally{if(o)throw r}}return e.length,e})}function z(){if(0===ge.length)return s.when([]);var e=_.indexBy(ge,"id"),t=f.lastChatSync;return a.info("synchronizing chat messages"+(t?" from "+t:"")),he.loadChatMessages(t).then(function(t){a.info("Found "+t.length+" chat messages to synchronize");var n=!0,o=!1,r=void 0;try{for(var i,c=t[Symbol.iterator]();!(n=(i=c.next()).done);n=!0)!function(){var t=i.value,n=e[t.match.id];d.saveChatMessage(t).then(function(e){e&&n&&(n.read=!1,n.lastMessage=t.text,te(n.id,!1))})}()}catch(s){o=!0,r=s}finally{try{!n&&c["return"]&&c["return"]()}finally{if(o)throw r}}if(t.length&&(f.lastChatSync=_.max(_.pluck(t,"createdAt"))),Ee){var l=_.indexBy(Se,"id"),u=!0,h=!1,g=void 0;try{for(var p,m=t[Symbol.iterator]();!(u=(p=m.next()).done);u=!0){var v=p.value;if(v.match.id==Ee&&!l[v.id]){var E=_.sortedIndex(Se,v.createdAt,"createdAt");Se.splice(E,0,v)}}}catch(s){h=!0,g=s}finally{try{!u&&m["return"]&&m["return"]()}finally{if(h)throw g}}}return t})}function Z(e){return _.find(ge,"id",e)}function X(e){return console.log("getActiveChat "+e),e===Ee?s.when(Se):d.getChatMessages(e).then(function(t){return Ee=e,Se=t})}function ee(e,t){if(!_.isBoolean(t))throw"read must be a boolean";var n=_.find(ge,{id:e});null!=n&&n.read!=t&&(n.read=t,d.setChatRead(e,t),te(e,t))}function te(t,n){n===!0||1===n?delete pe[t]:n===!1||0===n?pe[t]=!0:console.error("Invalid read argument to updateUnreadChatsCount()"),me=_.keys(pe).length,console.log("unread chats: "+me),e.$broadcast("unreadChatsCountUpdated")}function ne(){return me}function oe(){return he.resetBadge()}function re(e,t){g.eventTrack("chatMessage");var n=new Match;n.id=e;var o=new ChatMessage;return o.match=n,o.text=t,o.senderName=Ae.profile.name,he.sendChatMessage(o,_.find(ge,{id:e})).then(function(t){return console.log("sent chat message for match "+e),Ee==e&&(console.log("adding to active chat messages"),Se.push(t)),ae(e,t),t})}function ie(e,t){return g.eventTrack("reportProfile"),he.reportProfile(e,t)}function ae(e,t){var n=_.find(ge,{id:e});n&&(n.lastMessage=t.text,n.updatedAt=t.createdAt,ge.sort(function(e,t){return e.updatedAt.getTime()==t.updatedAt.getTime()?0:e.updatedAt.getTime()>t.updatedAt.getTime()?-1:1})),d.saveChatMessage(t),t.sender!=he.getUserId()&&ee(e,0)}function ce(){ye&&(console.log("Cancelling chat synchronization interval"),h.cancel(ye),ye=null,f.pushNotificationReceived=!0)}function se(t){if(console.log("newMessageNotification "+JSON.stringify(t)),t.createdAt=new Date(t.createdAt),Ee==t.match.id&&Se.push(t),ae(t.match.id,t),te(matchId,!1),e.$broadcast("newMessage",t),e.$apply(),Ae.profile.notifyMessage){var n=new Media(ue("audio/chat-notification.mp3"),null,null,null);i.play(n)}}function le(e){return g.eventTrack("contactMessage"),he.sendContactMessage(e)}function ue(e){return ionic.Platform.isIOS()?e:ionic.Platform.isAndroid()?"/android_asset/www/"+e:e}function de(e){return he.saveFile("photo.png",e).then(function(e){console.log("photo saved. saving profile...");var t={};return t.photos=Ae.profile.photos,t.photos||(t.photos=[]),t.photos.push(e),he.saveProfile(Ae.profile,t)}).then(function(e){return console.log("saved profile with photo"),e},function(e){return console.log("error saving photo file to profile "+JSON.stringify(e)),s.reject(e)})}function fe(e){return Ae.profile.birthdate=e,Ae.profile.ageFrom=Ae.profile.age-5,Ae.profile.ageFrom<18&&(Ae.profile.ageFrom=18),Ae.profile.ageTo=Ae.profile.age+5,he.saveProfile(Ae.profile,Ae.profile)}var he=u,ge=[],pe={},me=0,ve=[],Ee=null,Se=null,Pe=6e4,Me=10,Te=0,ye=null,Ae={isLoggedIn:!1,userId:"",fbId:"",profile:null,potentialMatches:null,init:p,facebookLogin:m,linkedInLogin:v,signUp:E,logIn:S,autoLogin:P,reloadUser:M,isEmailVerified:T,termsOfUseAgreed:y,requestPasswordReset:A,goToNextLoginState:w,loadProfile:b,getProfile:C,getProfileById:R,getProfileByMatchId:I,saveBirthdate:fe,saveProfile:F,saveSettings:U,enableDiscovery:k,getCurrentPosition:L,copyFacebookProfile:D,setPhoto:de,getPotentialMatches:q,updatePotentialMatches:W,clearPotentialMatches:Y,newMatchNotification:H,removeMatchNotification:J,deleteUnmatched:x,processMatch:B,getMutualMatches:K,getMatch:Z,getActiveChat:X,setChatRead:ee,getUnreadChatsCount:ne,sendChatMessage:re,removeMatch:j,reportProfile:ie,newMessageNotification:se,pushNotificationReceived:ce,resetBadge:oe,sendContactMessage:le,logout:G,deleteAccount:V};return Ae}])}();var userFields=["emailVerified","matches","profile"],profileFields=["uid","name","birthdate","age","about","photos","notifyMatch","notifyMessage","distance","distanceType","location","gps","enabled","gender","guys","girls","ageFrom","ageTo"],Profile=Parse.Object.extend({className:"Profile",attrs:profileFields}),matchFields=["uid1","uid2","uid1action","uid2action","state","profile1","profile2"],Match=Parse.Object.extend({className:"Match",attrs:matchFields}),chatMessageFields=["match","userIds","text","sender","senderName"],ChatMessage=Parse.Object.extend({className:"ChatMessage",attrs:chatMessageFields}),reportFields=["matchId","reportedBy","reported"],Report=Parse.Object.extend({className:"Report",attrs:reportFields}),contactMessageFields=["user","message"],ContactMessage=Parse.Object.extend({className:"ContactMessage",attrs:contactMessageFields});enhance(Parse.User.prototype,userFields),enhance(Profile.prototype,profileFields),enhance(Match.prototype,matchFields),enhance(ChatMessage.prototype,chatMessageFields),enhance(Report.prototype,reportFields),enhance(ContactMessage.prototype,contactMessageFields),Object.defineProperty(Profile.prototype,"photoUrl",{get:function(){return this.photos&&this.photos.length?this.photos[0].url():"img/generic_avatar.jpg"}}),Object.defineProperty(Match.prototype,"profileId",{get:function(){return null!=this.otherProfileId?this.otherProfileId:this.uid1==Parse.User.current().id?this.profile2.id:this.uid2==Parse.User.current().id?this.profile1.id:null}}),Object.defineProperty(Match.prototype,"profile",{get:function(){return this.otherProfile?this.otherProfile:this.otherProfileId?this.otherProfileId==this.profile1.id?this.profile1:this.profile2:this.uid1==Parse.User.current().id?this.profile2:this.uid2==Parse.User.current().id?this.profile1:null},set:function(e){this.otherProfile=e}}),angular.module("service.parse",["constants"]).factory("ParseService",["$q","$log","parseAppId","parseJavascriptKey","parseClientKey",function(e,t,n,o,r){function i(e){var t={};t.id=e.authResponse.userID,t.access_token=e.authResponse.accessToken;var n=new Date;return n.setSeconds(n.getSeconds()+e.authResponse.expiresIn),t.expiration_date=n.toISOString(),t}function a(){}function c(e,t){var n=e;return Parse.User.signUp(n,t,{email:e}).then(function(e){return h(),e},function(e){return console.log("signUp error: "+JSON.stringify(e)),e})}function s(e,t){return Parse.User.logIn(e,t).then(function(e){return h(),e},function(e){return e})}function l(e){return Parse.FacebookUtils.logIn(i(e)).then(function(e){return h(),e})}function u(e){return Parse.Cloud.run("LoadLinkedInMember",{authData:e}).then(function(e){return Parse.User.become(e)}).fail(k)}function d(){return Parse.Cloud.run("CopyFacebookProfile").fail(k)}function f(){h()}function h(){"undefined"!=typeof ParsePushPlugin&&(ParsePushPlugin.registerDevice({appId:n,clientKey:r,ecb:"onNotification",onOpen:"onNotificationOpen"},function(){console.log("successfully registered device for Parse Push"),ParsePushPlugin.getInstallationId(function(e){console.log("Parse Push InstallationId "+e)},function(e){console.log("getInstallationId error")}),ParsePushPlugin.subscribe("user_"+Parse.User.current().id,function(){console.log("Subscribed to parse push channel user_"+Parse.User.current().id)},function(e){console.log("Parse Push subscribe error "+e)})},function(e){console.log("ParsePushPlugin error registering device: "+e)}),ParsePushPlugin.on("receivePN",function(e){onNotification(e)}),ParsePushPlugin.on("openPN",function(e){onNotificationOpen(e)}))}function g(){return Parse.User.current().fetch()}function p(e){return e||null==Parse.User.current()||(e=Parse.User.current().getEmail()),Parse.User.requestPasswordReset(e)}function m(){return Parse.User.current().id}function v(){var n=Parse.User.current(),o=n.profile;return o?o.fetch():(t.debug("getProfile() fetching user"),n.fetch().then(function(){return n.profile?e.when():(t.debug("getProfile() fetching user again"),n.fetch())}).then(function(){return n.profile}))}function E(e){return Parse.Cloud.run("GetProfileForMatch",{matchId:e})}function S(e,t){return new Parse.GeoPoint({latitude:Math.round(100*e)/100,longitude:Math.round(100*t)/100})}function P(e,t){var n={notifyMatch:t.notifyMatch,notifyMessage:t.notifyMessage,distanceType:t.distanceType};return e.save(n)}function M(e,t){return t&&t.location&&(t.location=S(t.location.latitude,t.location.longitude)),t&&t.photos&&(t.photos=_.map(t.photos,function(e){return{name:e.name,url:e.url(),__type:"File"}})),e.save(t)}function T(e,t){var n=new Parse.File(e,{base64:t});return console.log("saving file "+e),n.save()}function y(e,t){return Parse.Cloud.run("ProcessMatch",{otherUserId:e.uid,liked:t})}function A(e){e||t.error("search parameters were not provided");for(var n={},o=0;o<profileFields.length;o++)n[profileFields[o]]=e[profileFields[o]];return Parse.Cloud.run("GetMatches",n)}function b(t){return 0===t.length?e.when([]):Parse.Cloud.run("GetMutualMatches",{matchIds:t})}function C(e){var t=new Parse.Query("ChatMessage"),n=new Match;return n.id=e,t.equalTo("match",n),t.ascending("createdAt"),t.limit(1e3),t.find()}function I(e){var t=new Parse.Query("ChatMessage");return t.equalTo("userIds",m()),e&&t.greaterThan("createdAt",e),t.ascending("createdAt"),t.limit(1e3),t.find()}function R(e,t){var n=new Parse.ACL;return n.setReadAccess(t.uid1,!0),n.setReadAccess(t.uid2,!0),m()===t.uid1?n.setWriteAccess(t.uid1,!0):n.setWriteAccess(t.uid2,!0),e.setACL(n),e.save()}function w(e){return Parse.Cloud.run("RemoveMatch",{matchId:e})}function O(e,t){var n=new Report;return n.reported=e.uid,n.reportedBy=m(),n.match=t,n.save()}function N(){var e=new Parse.Query("Match");e.equalTo("uid1",Parse.User.current().id),e.containedIn("state",["P","R"]);var t=new Parse.Query("Match");return t.equalTo("uid2",Parse.User.current().id),e.containedIn("state",["P","R"]),Parse.Query.or(e,t).find().then(function(e){return console.log("found "+e.length+" rejected matches to delete"),Parse.Object.destroyAll(e)})}function $(e){var t=new ContactMessage;return t.message=e,t.save()}function L(){"undefined"!=typeof ParsePushPlugin&&ParsePushPlugin.resetBadge(function(){return t.info("notification badge reset")},function(e){return t.error("error resetting badge "+JSON.stringify(e))})}function U(){return Parse.Cloud.run("DeleteAccount")}function D(){return"undefined"!=typeof ParsePushPlugin&&Parse.User.current()&&ParsePushPlugin.unsubscribe("user_"+Parse.User.current().id,function(e){console.log("ParsePush unsubscribed")},function(e){console.log("ParsePush unsubscribe error "+e)}),Parse.User.logOut()}function k(e){if(t.debug("unwrapping "+JSON.stringify(e)),141===e.code){if(e.message&&e.message.startsWith("{"))try{return e=JSON.parse(e.message)}catch(n){}"function not found"==e.message&&t.error("Have you deployed the latest Cloud Code?")}return e}Parse.initialize(n,o);var F={init:a,facebookLogin:l,linkedInLogin:u,signUp:c,logIn:s,autoLogin:f,registerPush:h,reloadUser:g,requestPasswordReset:p,copyFacebookProfile:d,getUserId:m,getProfile:v,getProfileForMatch:E,convertLocation:S,saveSettings:P,saveProfile:M,saveFile:T,searchProfiles:A,processProfile:y,deleteUnmatched:N,getMatches:b,getChatMessages:C,loadChatMessages:I,sendChatMessage:R,removeMatch:w,reportProfile:O,sendContactMessage:$,resetBadge:L,logout:D,deleteAccount:U};return F}]),function(){angular.module("service.localdb",[]).factory("LocalDB",["$q","$log",function(e,t){function n(e){this.url=function(){return e}}function o(e){for(var t=e.rows.length,o=[],r=0;t>r;r++){var i=e.rows.item(r),a=new Match;a.id=i.id,a.uid1=i.uid1,a.uid2=i.uid2;var c=new Profile;c.id=i.profile_id,c.name=i.name,c.location={latitude:i.latitude,longitude:i.longitude};var s=[];c.photos=s,i.photo1&&s.push(new n(i.photo1)),i.photo2&&s.push(new n(i.photo2)),i.photo3&&s.push(new n(i.photo3)),i.photo4&&s.push(new n(i.photo4)),i.photo5&&s.push(new n(i.photo5)),c.age=i.age,a.profile=c,a.otherProfileId=c.id,a.lastMessage=i.last_message,a.updatedAt=new Date(i.updated_at),a.read=1===i.read,o.push(a)}return o}function r(e){for(var t=e.rows.length,n=[],o=0;t>o;o++){var r=e.rows.item(o),i={};i.id=r.id,i.match={id:r.chat_id},i.sender=r.sender,i.text=r.message,i.createdAt=new Date(r.created_at),n.push(i)}return n}function i(){p=window.sqlitePlugin?window.sqlitePlugin.openDatabase({name:"my.db",location:2}):window.openDatabase("mydb","","LocalDB",2097152);var t=new g(p);return t.migration(1,function(e){e.executeSql("CREATE TABLE match (id varchar primary key, uid1 varchar, uid2 varchar, profile_id varchar, latitude real, longitude real, name varchar, photo1 varchar, photo2 varchar, photo3 varchar, birthdate date, last_message varchar, updated_at integer, read integer)"),e.executeSql("CREATE TABLE chat_message (id varchar primary key, chat_id varchar, created_at integer, sender varchar, message text)")}),t.migration(2,function(e){e.executeSql("ALTER TABLE match ADD COLUMN age integer"),e.executeSql("ALTER TABLE match ADD COLUMN photo4 varchar"),e.executeSql("ALTER TABLE match ADD COLUMN photo5 varchar")}),t.execute().then(function(){return e.when()})}function a(){t.log("Deleting database data");var n=e.defer();return p.transaction(function(e){e.executeSql("DELETE FROM match"),e.executeSql("DELETE FROM chat_message")},function(e){t.error("Error delete database data: "+e.message),n.reject(e)},function(){t.log("Database data deleted"),n.resolve()}),n.promise}function c(){var t=e.defer();return p.readTransaction(function(e){e.executeSql("SELECT * FROM match ORDER BY updated_at DESC",[],function(e,n){t.resolve(o(n))})},function(e){t.reject(e)}),t.promise}function s(n,o){var r=e.defer();return p.transaction(function(e){var t,r,i=o.photos,a=o.location;a&&(t=a.latitude,r=a.longitude),e.executeSql("INSERT INTO match (id, uid1, uid2, profile_id, name, photo1, photo2, photo3, photo4, photo5, latitude, longitude, age, last_message, updated_at, read) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)",[n.id,n.uid1,n.uid2,o.id,o.name,l(i,1),l(i,2),l(i,3),l(i,4),l(i,5),t,r,o.age,n.lastMessage,n.updatedAt.getTime(),0])},function(e){r.reject(e),t.error("Error saving match: "+JSON.stringify(e))},function(){r.resolve()}),r.promise}function l(e,t){return t<=e.length?e[t-1].url():null}function u(n){var o=e.defer();return p.transaction(function(e){e.executeSql("DELETE FROM match WHERE id=?",[n]),e.executeSql("DELETE FROM chat_message WHERE chat_id=?",[n])},function(e){o.reject(e),t.error("LocalDB Error deleting match: "+JSON.stringify(e))},function(){o.resolve()}),o.promise}function d(t){var n=e.defer();return p.readTransaction(function(e){e.executeSql("SELECT * FROM chat_message WHERE chat_id = ? ORDER BY created_at ASC",[t],function(e,t){n.resolve(r(t))})},function(e){n.reject(e)}),n.promise}function f(n){var o=e.defer(),r=!1;return p.transaction(function(e){e.executeSql("UPDATE match SET read = 0 WHERE NOT EXISTS (SELECT 1 FROM chat_message WHERE id = ?)",[n.id],function(e,t){r=t.rowsAffected>0}),e.executeSql("INSERT OR IGNORE INTO chat_message (id, chat_id, created_at, sender, message) VALUES (?,?,?,?,?)",[n.id,n.match.id,n.createdAt.getTime(),n.sender,n.text]),e.executeSql("UPDATE match SET updated_at = ?, last_message = ? WHERE id = ? and ? > updated_at",[n.createdAt.getTime(),n.text,n.match.id,n.createdAt.getTime()])},function(e){o.reject(e),t.error("Error saving chat message: "+JSON.stringify(e))},function(){t.debug("saved chat message new:"+r),o.resolve(r)}),o.promise}function h(n,o){if(!_.isBoolean(o))throw console.log("read "+o),"read must be a boolean. Was "+o;var r=o?1:0,i=e.defer();return p.transaction(function(e){e.executeSql("UPDATE match SET read = ? WHERE id = ?",[r,n])},function(e){i.reject(e),t.error("Error updating read flag: "+JSON.stringify(e))},function(){i.resolve()}),i.promise}function g(n){function o(r){var s=e.defer();return i[r]?n.transaction(function(e){e.executeSql("update "+c+" set version = ?",[r],function(e){t.info("Beginning migration "+r),i[r](e),t.info("Completed migration "+r),o(r+1).then(function(){return s.resolve()})},function(e,n){t.error("Error!: %o (while upgrading to %s from %s)",n,r),s.reject(n)})}):(t.debug("Migrations complete."),a=2,s.resolve()),s.promise}function r(n){a=1,t.debug("Main Migrator starting");var r=e.defer();try{return o(n+1).then(function(){return r.resolve()})}catch(i){r.reject(i)}return r.promise}var i=[],a=0,c="version";this.migration=function(e,t){i[e]=t},this.execute=function(){var o=e.defer();if(a>0)throw"Migrator is only valid once -- create a new one if you want to do another migration.";return n.transaction(function(e){e.executeSql("select version from "+c,[],function(e,n){var i=n.rows,a=i.item(0).version;t.info("Existing database present, migrating from "+a),r(a).then(function(){return o.resolve()})},function(e,n){n.message.match(/no such table/i)?e.executeSql("create table "+c+"(version integer)",[],function(){e.executeSql("insert into "+c+" values(0)",[],function(){t.info("New migration database created..."),r(0).then(function(){return o.resolve()})},function(e,n){t.error("Unrecoverable error inserting initial version into db: %o",n),o.reject(n)})},function(e,n){t.error("Unrecoverable error creating version table: %o",n),o.reject(n)}):(t.error("Unrecoverable error resolving schema version: %o",n),o.reject(n))})}),o.promise}}var p,m={userId:"",init:i,getMatches:c,saveMatch:s,deleteMatch:u,getChatMessages:d,saveChatMessage:f,setChatRead:h,deleteDb:a};return m}])}();var platformReady,fbLoaded,app=angular.module("ionicApp",["constants","ionic","AppUtil","templates","controllers","controllers.share","service.app","ui.slider","ngImgCrop","ngAnimate","pascalprecht.translate","emoji","ImgCache","monospaced.elastic","ngStorage","angulartics.parse","SocialAuth"]).run(["$ionicPlatform","AppService","ImgCache","$rootScope","appName",function(e,t,n,o,r){o.appName=r,e.ready(function(){console.log("ionicPlatform.ready"),window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault(),n.init(function(){console.log("ImgCache init: success!")},function(){console.log("ImgCache init: error! Check the log for errors")}),t.init(),platformReady="true"});

}]).config(["$translateProvider",function(e){e.translations("en",TRANSLATION_EN),e.translations("de",TRANSLATION_DE),e.preferredLanguage("en")}]).config(["$compileProvider","buildEnv",function(e,t){"prod"===t&&(console.log("Disabling $compileProvider debug info"),e.debugInfoEnabled(!1))}]).config(["$cordovaFacebookProvider","facebookAppId",function(e,t){e.setAppID(t,"v2.0")}]).config(["$ionicConfigProvider",function(e){e.backButton.text("").previousTitleText(!1),(!ionic.Platform.isWebView()||ionic.Platform.isIOS())&&e.backButton.text("").icon("ion-ios-arrow-back")}]).config(["ImgCacheProvider",function(e){e.setOptions({usePersistentCache:!0}),e.manualInit=!0}]).filter("escapeHTML",function(){return function(e){return e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#39;").replace(/"/g,"&quot;"):""}}).directive("input",["$timeout",function(e){return{restrict:"E",scope:{returnClose:"=",onReturn:"&",onFocus:"&",onBlur:"&"},link:function(t,n,o){n.bind("focus",function(n){t.onFocus&&e(function(){t.onFocus()})}),n.bind("blur",function(n){t.onBlur&&e(function(){t.onBlur()})}),n.bind("keydown",function(o){13==o.which&&(t.returnClose&&n[0].blur(),t.onReturn&&e(function(){t.onReturn()}))})}}}]);angular.module("ionicApp").config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("signin",{url:"/sign-in",templateUrl:"sign-in.html",controller:"SignInCtrl"}).state("emailVerification",{url:"/emailVerification",templateUrl:"emailVerification.html",controller:"EmailVerificationCtrl"}).state("profileSetup",{url:"/profileSetup",templateUrl:"profileSetup.html",controller:"ProfileSetupCtrl"}).state("locationSetup",{url:"/locationSetup",templateUrl:"locationSetup.html",controller:"LocationSetupCtrl"}).state("termsOfUse",{url:"/termsOfUse",templateUrl:"termsOfUse.html",controller:"TermsOfUseCtrl"}).state("menu",{url:"/menu","abstract":!0,templateUrl:"menu.html"}).state("menu.home",{url:"/home",views:{menuContent:{templateUrl:"swipe.html",controller:"CardsCtrl"}}}).state("menu.card-info",{url:"/card-info",views:{menuContent:{templateUrl:"profileView.html",controller:"CardInfoCtrl"}}}).state("menu.match-profile",{url:"/match-profile/:matchId/:profileId",views:{menuContent:{templateUrl:"matchProfile.html",controller:"MatchProfileCtrl"}},resolve:{matchProfile:["AppService","$stateParams",function(e,t){return t.matchId?e.getProfileByMatchId(t.matchId):t.profileId?e.getProfileById(t.profileId):void 0}]}}).state("menu.chats",{url:"/chats",views:{menuContent:{templateUrl:"chats.html",controller:"ChatsCtrl"}}}).state("menu.chat",{url:"/chat/:matchId",views:{menuContent:{templateUrl:"chat.html",controller:"ChatCtrl"}}}).state("menu.profile",{url:"/profile",views:{menuContent:{templateUrl:"profile.html",controller:"ProfileCtrl"}}}).state("menu.profile-edit",{url:"/profile-edit",views:{menuContent:{templateUrl:"profileEdit.html"}}}).state("menu.fb-albums",{url:"/fb-albums",views:{menuContent:{templateUrl:"fbAlbums.html",controller:"FbAlbumsCtrl"}}}).state("menu.fb-album",{url:"/fb-album/:albumId",views:{menuContent:{templateUrl:"fbAlbum.html",controller:"FbAlbumCtrl"}}}).state("menu.crop",{url:"/crop",views:{menuContent:{templateUrl:"crop.html",controller:"PhotoCropCtrl"}}}).state("menu.discovery",{url:"/discovery",views:{menuContent:{templateUrl:"discovery.html",controller:"DiscoveryCtrl"}}}).state("menu.location",{url:"/location",views:{menuContent:{templateUrl:"locationMap.html",controller:"LocationCtrl"}}}).state("menu.settings",{url:"/settings",views:{menuContent:{templateUrl:"settings.html",controller:"SettingsCtrl"}}}).state("menu.contact",{url:"/contact",views:{menuContent:{templateUrl:"contact.html",controller:"ContactCtrl"}}}),t.otherwise("/sign-in")}]),app.config(["$provide",function(e){var t="$$ChildScope",n="$$watchers",o="$$nextSibling",r="$$childHead",i="$$childTail",a="$$listeners",c="$$listenerCount",s="$id",l="$parent",u="$$prevSibling",d="$$destroyed";e.decorator("$rootScope",["$delegate",function(e){function f(){return++e[s]}function h(e){e.$id=f(),e.$$phase=e.$parent=e.$$watchers=e.$$nextSibling=e.$$prevSibling=e.$$childHead=e.$$childTail=null,e.$root=this,e.$$destroyed=!1,e.$$listeners={},e.$$listenerCount={},e.$$isolateBindings=null}var g=Object.getPrototypeOf(e);return g.$new=function(g,p){function m(){v[d]=!0}var v;return p=p||this,g?(v=Object.create(Object.getPrototypeOf(e)),h(v),v.$root=this.$root):(this[t]||(this[t]=function(){this[n]=this[o]=this[r]=this[i]=null,this[a]={},this[c]={},this[s]=f(),this[t]=null},this[t].prototype=this),v=new this[t]),v[l]=p,v[u]=p[i],p[r]?(p[i][o]=v,p[i]=v):p[r]=p[i]=v,(g||p!=this)&&v.$on("$destroy",m),v},e.$new=g.$new,e}])}]),angular.module("controllers",["service.app","ngMaterial","ngAnimate","ngCordova","ionic.contrib.ui.tinderCards"]).controller("SignInCtrl",["$scope","$log","$rootScope","$state","$http","$timeout","$cordovaFacebook","$q","$ionicPopup","$ionicModal","$ionicLoading","$ionicHistory","AppService","AppUtil","SocialAuth","linkedInId","linkedInSecret",function(e,t,n,o,r,i,a,c,s,l,u,d,f,h,g,p,m){function v(){e.showForm=!0,e.showLogo=!1,e.logo["class"]="",e.status=""}function E(){e.showForm=!1,e.showLogo=!0,e.logo["class"]="pulse",e.status=""}function S(){return M()||P()}function P(){return e.credentials.password.length<6?(h.toastSimpleTranslate("PASSWORD_LENGTH"),!0):!1}function M(){var t=/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return t.test(e.credentials.email)?!1:(h.toastSimpleTranslate("INVALID_EMAIL"),!0)}function T(n){var o=f.getCurrentPosition(),r=n?c.when(n):f.loadProfile();r.then(function(t){return t?t.gps?(e.status="WAITING_FOR_GPS",o.then(function(e){return e},function(e){return null})):null:c.reject("Unable to load Profile")}).then(function(e){var t=f.getProfile();return t.gps&&null!=e?(console.log("updating location to "+JSON.stringify(e)),void f.saveProfile({location:e}).always(function(){return y(t)})):void y(t)},function(e){return v(),f.logout(),t.error("Error loging in: "+JSON.stringify(e)),209===e.code?void h.toastSimple("Invalid session. Try again"):void h.toastSimpleTranslate("LOGIN_ERROR")})}function y(){e.status="",e.logo["class"]="drop",f.getMutualMatches(),d.nextViewOptions({historyRoot:!0,disableBack:!0}),i(function(){return f.goToNextLoginState()},500)}function A(e){(window.cordova||fbLoaded)&&platformReady?e&&i(e,50):i(function(){A(e)},50)}e.credentials={email:"",password:""},e.logo={"class":""},e.showForm=!1,e.showLogo=!1,e.showResetPassword=!1,e.showResetPasswordForm=function(){e.showForm=!1,e.showResetPassword=!0},e.hideResetPasswordForm=function(){e.showForm=!0,e.showResetPassword=!1},e.resetPassword=function(){M()||(u.show({templateUrl:"loading.html"}),f.requestPasswordReset(e.credentials.email).then(function(){e.hideResetPasswordForm(),h.toastSimpleTranslate("PASSWORD_RESET_SENT")},function(e){h.toastSimpleTranslate("REQUEST_FAILED")}).always(function(){u.hide()}))},e.emailRegister=function(){S()||(E(),f.signUp(e.credentials.email,e.credentials.password).then(function(t){console.log("user signed up success"),e.status="termsOfUse"},function(t){v(),e.status="termsOfUse",console.log("user signed up error "+JSON.stringify(t)),h.toastSimple(t.message)}))},e.emailLogin=function(){S()||(E(),f.logIn(e.credentials.email,e.credentials.password).then(function(t){console.log("user login success"),e.status="LOADING_PROFILE"},function(e){v(),console.log("user login error "+JSON.stringify(e)),h.toastSimple("Login error")}))},e.linkedInLogin=function(){E(),e.status="LOGGING_IN_TO_LINKEDIN",g.linkedIn(p,m,["r_basicprofile","r_emailaddress"],"rtbwrtusgfxytr").then(function(e){return f.linkedInLogin(e)}).then(function(){return T(null)},function(e){v(),t.error(e),f.logout(),h.toastSimple("LinkedIn login failed")})},e.facebookLogin=function(){E(),e.status="LOGGING_IN_TO_FB",b().then(function(e){return f.facebookLogin(e)}).then(function(t){return e.status="LOADING_PROFILE",f.loadProfile()}).then(function(t){return t.name?t:(console.log("Initialising profile with facebook profile"),e.status="LOADING_FB_PROFILE",f.copyFacebookProfile())}).then(function(){return T()},e._handleFacebookLoginError)},e._handleFacebookLoginError=function(e){return v(),e.code&&"MINIMUM_AGE_ERROR"===e.code?void s.alert({title:"Error",template:"You do not meet the age requirements for this app."}).then(function(){return f.logout()}):(t.error("Facebook login error: "+JSON.stringify(e)),f.logout(),void h.toastSimpleTranslate("LOGIN_ERROR"))};var b=function(){var t=c.defer();return e.status="LOGGING_IN_TO_FB",a.getLoginStatus().then(function(e){"connected"===e.status?(console.log("setting $rootScope.facebookConnected"),n.facebookConnected=!0,n.fbAccessToken=e.authResponse.accessToken,t.resolve(e)):(console.log("$cordovaFacebook.login"),a.login(["public_profile","email","user_birthday","user_photos","user_friends","user_likes"]).then(function(e){"connected"===e.status?(console.log("setting $rootScope.facebookConnected"),n.facebookConnected=!0,n.fbAccessToken=e.authResponse.accessToken,t.resolve(e)):t.reject(e)},function(e){return t.reject(e)}))},function(e){t.reject(e)}),t.promise},C=function(){null!=Parse.User.current()?(console.log("auto login"),E(),f.autoLogin(),Parse.FacebookUtils.isLinked(Parse.User.current())?(console.log("Checking facebook user"),b().then(function(e){T()},function(e){v(),h.toastSimple("Facebook login error")})):T()):v()};A(C)}]),angular.module("controllers").controller("CardsCtrl",["$scope","$state","$timeout","$translate","$mdToast","$ionicSideMenuDelegate","TDCardDelegate","AppService","$ionicModal","$ionicLoading",function(e,t,n,o,r,i,a,c,s,l){function u(){var t=Date.now();c.updatePotentialMatches().then(function(o){console.log("CardsCtrl: found "+o.length+" potential matches"),o.map(function(e){e.image=e.photoUrl});var r=Date.now()-t;h>r?n(function(){e.matches=o},h-r):e.$apply(function(){e.matches=o})},function(t){console.log("updatePotentialMatches error "+JSON.stringify(t)),e.$apply(function(){e.matches=[]}),r.show(r.simple().content(d.MATCHES_LOAD_ERROR).hideDelay(2e3))})}var d;o(["MATCHES_LOAD_ERROR"]).then(function(e){d=e}),e.matches=null;var f=e.profile=c.getProfile();e.profilePhoto=f.photoUrl,e.$on("$ionicView.beforeEnter",function(){e.unreadChats=c.getUnreadChatsCount()>0}),e.$on("$ionicView.enter",function(){f.enabled&&(e.matches=c.getPotentialMatches(),null==e.matches&&u())}),e.$on("newPotentialMatches",function(){console.log("newPotentialMatches"),e.$apply(function(){e.matches=c.getPotentialMatches()})}),e.$on("unreadChatsCountUpdated",function(){e.unreadChats=c.getUnreadChatsCount()>0}),e.searchAgain=function(){e.matches=null,u()};var h=2e3;s.fromTemplateUrl("newMatch.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.modal=t}),e.$on("$destroy",function(){e.modal.remove()}),e.$on("newMatch",function(t,n){console.log("CardsCtrl.newMatch "+n.id),e.newMatch=n,e.matchProfile=c.getProfileById(n.profileId),e.modal.show()}),e.closeNewMatch=function(){e.modal.hide()},e.messageNewMatch=function(){e.modal.hide(),t.go("^.chat",{matchId:e.newMatch.id})},e.openNewMatch=function(){e.newMatch=c.getMutualMatches()[0],e.modal.show()},e.enableDiscovery=function(){l.show({templateUrl:"loading.html"}),e.matches=null,c.enableDiscovery().then(function(e){l.hide(),console.log("discovery enabled. updatin matches..."),u()},function(e){r.show(r.simple().content("Error setting discovery").hideDelay(2e3)),l.hide()})},e.viewDetails=function(n){console.log("view details "+JSON.stringify(n)),e.$parent.selectedCard=n,t.go("^.card-info")},e.accept=function(t){console.log("accept button"),a.popCard(e,!0)},e.reject=function(t){console.log("reject button"),a.popCard(e,!0)},e.cardDestroyed=function(t){e.matches.splice(t,1)},e.cardTransitionLeft=function(t){c.processMatch(t,!1),0==e.matches.length},e.cardTransitionRight=function(t){c.processMatch(t,!0),0==e.matches.length}}]).controller("CardInfoCtrl",["$scope","$cordovaFacebook","$ionicHistory","$ionicActionSheet","$ionicLoading","$mdToast","$translate","AppService",function(e,t,n,o,r,i,a,c){function s(){var e=c.getPotentialMatches().pop();r.show({templateUrl:"loading.html"}),c.reportProfile(e).then(function(t){console.log("reported profile"),r.hide(),c.processMatch(e,!1),n.goBack()},function(e){r.hide(),i.show(i.simple().content(l.REQUEST_FAILED).hideDelay(2e3)),console.log("error reporting profile "+JSON.stringify(e))})}var l;a(["REQUEST_FAILED","REPORT","MATCH_OPTIONS","CANCEL"]).then(function(e){l=e}),e.profile=c.getProfile();var u=e.profile.location,d=e.selectedCard.location,f=getDistanceFromLatLonInKm(u.latitude,u.longitude,d.latitude,d.longitude);"mi"==e.profile.distanceType&&(f*=1.609344),f=f.toFixed(0),e.distance=0==f?1:f,e.like=function(){var e=c.getPotentialMatches().pop();c.processMatch(e,!0),n.goBack()},e.reject=function(){var e=c.getPotentialMatches().pop();c.processMatch(e,!1),n.goBack()},e.profileOptions=function(){o.show({destructiveText:l.REPORT,titleText:l.MATCH_OPTIONS,cancelText:l.CANCEL,cancel:function(){},destructiveButtonClicked:function(e){return s(),!0}})}}]).controller("MatchProfileCtrl",["$scope","$cordovaFacebook","$ionicHistory","AppService","matchProfile",function(e,t,n,o,r){e.profile=o.getProfile(),e.matchProfile=r;var i=e.profile.location,a=r.location,c=getDistanceFromLatLonInKm(i.latitude,i.longitude,a.latitude,a.longitude);"mi"==e.profile.distanceType&&(c*=1.609344),c=c.toFixed(0),e.distance=0==c?1:c}]),angular.module("controllers").controller("EmailVerificationCtrl",["$scope","AppService","AppUtil",function(e,t,n){e.isEmailVerified=function(){return n.blockingCall(t.isEmailVerified(),function(e){return e?t.goToNextLoginState():n.toastSimpleTranslate("EMAIL_NOT_VERIFIED")})},e.cancel=function(){return t.logout()}}]).controller("ProfileSetupCtrl",["$scope","$state","$mdToast","AppService","AppUtil",function(e,t,n,o,r){e.$on("$ionicView.beforeEnter",function(t){var n=o.getProfile(),r=null,i=null;n.birthdate&&(r=n.birthdate.getFullYear(),i=n.birthdate.getMonth()),e.user={name:n.name,birthYear:r,birthMonth:i,gender:n.gender}}),e.months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],e.years=[];for(var i=(new Date).getFullYear()-100,a=(new Date).getFullYear()-13,c=i;a>=c;c++)e.years.push(c);e.yearFrom=i,e.yearTo=a,e.saveProfile=function(){if(e.user.name.length<1)return void r.toastSimpleTranslate("FIRST_NAME_REQUIRED");if(!e.user.birthMonth)return void r.toastSimpleTranslate("BIRTH_MONTH_REQUIRED");if(!e.user.birthYear)return void r.toastSimpleTranslate("BIRTH_YEAR_REQUIRED");if(!e.user.gender)return void r.toastSimpleTranslate("GENDER_REQUIRED");var t=new Date(e.user.birthYear,e.user.birthMonth,1),n={name:e.user.name,birthdate:t,gender:e.user.gender};r.blockingCall(o.saveProfile(n),function(){return o.goToNextLoginState()},"SETTINGS_SAVE_ERROR")},e.logout=function(){return o.logout()}}]).controller("LocationSetupCtrl",["$scope","$translate","AppService","AppUtil","$ionicPopup",function(e,t,n,o,r){var i;t(["SETTINGS_SAVE_ERROR","GPS_ERROR","SET_MAP_LOCATION"]).then(function(e){i=e});var a=new google.maps.LatLng(40.73,-73.99),c={center:a,zoom:11,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:!1,streetViewControl:!1,disableDoubleClickZoom:!0},s=new google.maps.Map(document.getElementById("map"),c);e.map=s,s.setCenter(a);var l=new google.maps.Marker({position:a,map:s,title:"My Location",draggable:!0});google.maps.event.addListener(s,"click",function(e){l.setPosition(e.latLng)}),e.setLocation=function(){var e=l.getPosition();o.blockingCall(n.saveProfile({gps:!1,location:{latitude:e.lat(),longitude:e.lng()}}),function(){return n.goToNextLoginState()},"SETTINGS_SAVE_ERROR")},e.cancel=function(){return n.logout()},e.$on("$ionicView.afterEnter",function(e){r.alert({title:i.GPS_ERROR,template:i.SET_MAP_LOCATION})})}]).controller("TermsOfUseCtrl",["$scope","AppService","AppUtil",function(e,t,n){e.agree=function(){return n.blockingCall(t.termsOfUseAgreed(),function(){return t.goToNextLoginState()})},e.logout=function(){return t.logout()}}]).controller("ProfileCtrl",["$scope","$rootScope","$state","$cordovaFacebook","$mdToast","AppService",function(e,t,n,o,r,i){e.$on("$ionicView.beforeEnter",function(n){if(e.profile=i.getProfile(),e.photos=e.profile.photos,e.age=new Date(new Date-new Date(e.profile.birthdate)).getFullYear()-1970,t.facebookConnected){var r=localStorage.getItem("facebookLikes");r&&(e.likes=JSON.parse(r));var a=localStorage.getItem("facebookFriends");a&&(e.friends=JSON.parse(a)),o.api("/me/friends").then(function(t){console.log(JSON.stringify(t.data)),e.friends=t.data,localStorage.setItem("facebookFriends",JSON.stringify(t.data)),o.api("/me/likes").then(function(t){e.likes=t.data,localStorage.setItem("facebookLikes",JSON.stringify(t.data))})})}}),e.edit=function(){n.go("menu.profile-edit")}}]).controller("FbAlbumsCtrl",["$scope","$cordovaFacebook",function(e,t){e.albums=null,t.api("/me/albums").then(function(t){e.albums=t.data},function(e){console.log("FbAlbumsController error "+JSON.stringify(e))})}]).controller("FbAlbumCtrl",["$rootScope","$state","$scope","$stateParams","$ionicLoading","$cordovaFacebook",function(e,t,n,o,r,i){function a(n){var o=new Image;o.crossOrigin="anonymous",o.src=n,o.onload=function(){var n=document.createElement("canvas");n.width=this.width,n.height=this.height;var o=n.getContext("2d");o.drawImage(this,0,0);var i=n.toDataURL("image/png");e.cropPhoto=i,r.hide(),t.go("^.crop")}}i.api("/"+o.albumId+"/photos?fields=id,picture,source,height,width,images&limit=500").then(function(e){n.photos=e.data},function(e){console.log("FbAlbumController - error getting album photos "+JSON.stringify(e))}),n.selectPhoto=function(e){r.show({templateUrl:"loading.html"}),a(e.source)}}]).controller("PhotoCropCtrl",["$scope","$rootScope","$ionicLoading","$state","$stateParams","$ionicHistory","AppService",function(e,t,n,o,r,i,a){e.myImage=t.cropPhoto,e.croppedImage={data:""},e.$on("$ionicView.afterLeave",function(e){t.cropPhoto=null}),e.cancel=function(){i.goBack()},e.crop=function(){n.show({templateUrl:"loading.html"});try{var t,o=e.croppedImage.data;t=o.split(",")[0].indexOf("base64")>=0?o.split(",")[1]:unescape(o.split(",")[1]),a.setPhoto(t).then(function(e){n.hide();var t=i.viewHistory();if("menu.fb-album"==t.backView.stateName){var o=t.histories[t.currentView.historyId];o.stack.splice(2,3),o.cursor=1,t.backView=o.stack[1],i.goBack()}else i.goBack()},function(e){n.hide(),console.log("error saving cropped image "+JSON.error(e))})}catch(r){n.hide()}}}]).controller("DiscoveryCtrl",["$scope","$state","$mdToast","$ionicLoading","$ionicHistory","AppService","AppUtil",function(e,t,n,o,r,i,a){e.$on("$ionicView.enter",function(){e.profile=i.getProfile().clone()}),e.save=function(){return a.blockingCall(i.saveProfile(e.profile),function(){i.clearPotentialMatches(),t.go("menu.home")},"SETTINGS_SAVE_ERROR")},e.cancel=function(){e.profile=i.getProfile(e).clone()}}]).controller("SettingsCtrl",["$scope","$rootScope","$state","$translate","$mdToast","AppService","$ionicLoading","$ionicActionSheet","$cordovaFacebook",function(e,t,n,o,r,i,a,c,s){function l(){a.show({templateUrl:"loading.html"}),i.deleteAccount().then(function(t){a.hide(),e.logout()},function(e){a.hide(),console.log("error deleting account "+JSON.stringify(e))})}var u;o(["SETTINGS_SAVE_ERROR","DELETE","DELETE_ACCOUNT","CANCEL"]).then(function(e){u=e}),e.profile=i.getProfile().clone(),e.save=function(){a.show({templateUrl:"loading.html"}),i.saveSettings(e.profile).then(function(t){e.profile=i.getProfile().clone()},function(e){console.log("save settings error "+JSON.stringify(e)),r.show(r.simple().content(u.SETTINGS_SAVE_ERROR).hideDelay(2e3))}).always(function(){a.hide()})},e.cancel=function(){e.profile=i.getProfile(e).clone()},e.logout=function(){i.logout()},e.deleteUnmatchedSwipes=function(){a.show({templateUrl:"loading.html"}),i.deleteUnmatched().then(function(e){a.hide()},function(e){a.hide(),console.log("error deleting unmatched swipes "+JSON.stringify(e)),r.show(r.simple().content("An error occured "+JSON.stringify(e)).hideDelay(3e3))})},e.deleteAccount=function(){c.show({destructiveText:u.DELETE,titleText:u.DELETE_ACCOUNT,cancelText:u.CANCEL,cancel:function(){},destructiveButtonClicked:function(e){return l(),!0}})}}]).controller("ContactCtrl",["$scope","AppService","$ionicLoading","$mdToast",function(e,t,n,o){e.contact={message:""},e.sendMessage=function(){return e.contact.message.length<10?void o.show(o.simple().content("Write at least a few words!").hideDelay(2e3)):(n.show({templateUrl:"loading.html"}),void t.sendContactMessage(e.contact.message).then(function(t){e.contact.message="",o.show(o.simple().content("Message sent").hideDelay(3e3))},function(e){o.show(o.simple().content("An error occurred").hideDelay(3e3))}).always(function(){n.hide()}))}}]).controller("LocationCtrl",["$scope","$translate","AppService","$ionicLoading","$mdToast","AppUtil",function(e,t,n,o,r,i){var a;t(["SETTINGS_SAVE_ERROR","GPS_ERROR"]).then(function(e){a=e});var c=n.getProfile(),s=c.location;e.location={useGPS:c.gps};var l=new google.maps.LatLng(s.latitude,s.longitude),u={center:l,zoom:11,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:!1,streetViewControl:!1,disableDoubleClickZoom:!0},d=new google.maps.Map(document.getElementById("map"),u);e.map=d,d.setCenter(l);var f=new google.maps.Marker({position:l,map:d,title:"My Location",draggable:!c.gps});google.maps.event.addListener(d,"click",function(t){e.location.useGPS||f.setPosition(t.latLng)}),e.useGPSchanged=function(){f.setDraggable(!e.location.useGPS),e.location.useGPS&&(o.show({templateUrl:"loading.html"}),n.getCurrentPosition().then(function(e){return n.saveProfile({gps:!0,location:e})}).then(function(e){f.setPosition(new google.maps.LatLng(e.location.latitude,e.location.longitude)),o.hide()},function(t){o.hide(),r.show("GPS_ERROR"==t?r.simple().content(a.GPS_ERROR).hideDelay(2e3):r.simple().content(a.SETTINGS_SAVE_ERROR).hideDelay(2e3)),e.location.useGPS=!1,f.setDraggable(!0)}))},e.setLocation=function(){var e=f.getPosition();o.show({templateUrl:"loading.html"}),n.saveProfile({gps:!1,location:{latitude:e.lat(),longitude:e.lng()}}).then(function(){},function(e){r.show(r.simple().content(a.SETTINGS_SAVE_ERROR).hideDelay(2e3))}).always(function(){o.hide()})}}]),angular.module("controllers").controller("ChatsCtrl",["$scope","AppService",function(e,t){e.$on("$ionicView.beforeEnter",function(){e.matches=t.getMutualMatches(),t.resetBadge()}),e.$on("matchRemoved",function(t,n){console.log("on ChatsCtrl removeMatch"),e.$apply()})}]).controller("ChatCtrl",["$scope","$log","$timeout","$interval","$translate","$ionicScrollDelegate","$state","$stateParams","$ionicHistory","$ionicNavBarDelegate","$ionicActionSheet","$ionicPopup","$ionicLoading","$mdToast","AppService","AppUtil",function(e,t,n,o,r,i,a,c,s,l,u,d,f,h,g,p){function m(){f.show({templateUrl:"loading.html"}),g.reportProfile(e.matchProfile,e.match).then(function(e){console.log("reported match"),f.hide();var t=d.confirm({title:M.MATCH_REPORTED,template:M.WANT_TO_REMOVE_MATCH,okText:M.REMOVE,cancelText:M.CANCEL});t.then(function(e){e&&v()})},function(e){f.hide(),h.show(h.simple().content(M.REQUEST_FAILED).hideDelay(2e3)),console.log("error reporting match "+JSON.stringify(e))})}function v(){f.show({templateUrl:"loading.html"}),g.removeMatch(c.matchId).then(function(e){console.log("removed match ok"),f.hide(),s.goBack()},function(e){f.hide(),h.show(h.simple().content(M.REMOVE_MATCH_ERROR).hideDelay(2e3)),console.log("error removing match "+JSON.stringify(e))})}function E(){b.one("blur",function(){b[0].focus()})}function S(e){I=e.keyboardHeight}function P(e){I=0,n(function(){A.style.bottom=y.clientHeight+"px"},0)}var M;r(["UNMATCHED","REMOVE_MATCH","REPORT","MATCH_OPTIONS","CANCEL","REMOVE_MATCH_ERROR","MATCH_REPORTED","WANT_TO_REMOVE_MATCH","REMOVE","MESSAGE_NOT_SENT","REQUEST_FAILED"]).then(function(e){M=e}),e.sending=!1,e.profile=g.getProfile();var T,y,A,b,C=i.$getByHandle("userMessageScroll");e.$on("$ionicView.enter",function(){window.cordova&&(cordova.plugins.Keyboard.disableScroll(!0),window.addEventListener("native.keyboardshow",S),window.addEventListener("native.keyboardhide",P)),f.show({templateUrl:"loading.html",noBackdrop:!0}),g.getActiveChat(c.matchId).then(function(t){return e.messages=t,g.getProfileByMatchId(c.matchId)}).then(function(t){return e.matchProfile=t}).then(function(){e.doneLoading=!0,e.input={message:localStorage["userMessage-"+e.matchProfile.id]||""},C.scrollBottom(),f.hide(),n(function(){y=document.body.querySelector("#userMessagesView .bar-footer"),A=document.body.querySelector("#userMessagesView .scroll-content"),b=angular.element(y.querySelector("textarea"))},0),T=o(function(){},2e4)},function(t){e.messages=[],f.hide(),console.log("error loading chat "+JSON.stringify(t)),p.toastSimpleTranslate("REQUEST_FAILED")})}),e.$on("$ionicView.afterEnter",function(){g.setChatRead(c.matchId,!0),e.match=g.getMatch(c.matchId)}),e.$on("$ionicView.beforeLeave",function(){e.input.message&&0!=e.input.message.trim().length?localStorage["userMessage-"+e.matchProfile.id]=e.input.message:localStorage.removeItem("userMessage-"+e.matchProfile.id)}),e.$on("$ionicView.leave",function(){window.cordova&&(window.removeEventListener("native.keyboardshow",S),window.removeEventListener("native.keyboardhide",P),cordova.plugins.Keyboard.disableScroll(!1)),angular.isDefined(T)&&(o.cancel(T),T=void 0)}),e.$on("newMessage",function(e,t){t.match.id==c.matchId&&(i.scrollBottom(!0),g.setChatRead(t.match.id,!0))}),e.$on("matchRemoved",function(e,t){console.log("on ChatCtrl matchRemoved"),t==c.matchId&&(h.show(h.simple().content(M.UNMATCHED).hideDelay(2e3)),s.goBack())}),e.chatOptions=function(){u.show({buttons:[{text:M.REPORT}],destructiveText:M.REMOVE_MATCH,titleText:M.MATCH_OPTIONS,cancelText:M.CANCEL,cancel:function(){},destructiveButtonClicked:function(e){return v(),!0},buttonClicked:function(e){return m(),!0}})},e.sendMessage=function(o){if(e.input.message.trim().length){E();var r=e.input.message;e.input.message="",g.sendChatMessage(c.matchId,r).then(function(e){n(function(){E(),C.scrollBottom(!0)},0)},function(n){t.error("error sending message "+JSON.stringify(n)),e.input.message||(e.input.message=r),p.toastSimple(M.MESSAGE_NOT_SENT)})}},e.onMessageHold=function(e,t,n){};var I=0;e.$on("elastic:resize",function(e,t){if(t){var n=t[0].offsetHeight;if(y){var o=n+10;o=o>44?o:44,y.style.height=o+"px",A.style.bottom="ios"===device.platform.toLowerCase()?o+I+"px":o+"px"}}})}]),angular.module("constants",[]).constant("appName","").constant("playStoreUrl","").constant("itunesUrl","").constant("socialShareMessage","").constant("buildEnv","dev").constant("facebookAppId","470904259739082").constant("facebookAppName","join").constant("parseAppId","hcTsndhxxAO2HFPt3WXSk3G3UfpxXtRKrQwy6TQC").constant("parseJavascriptKey","3JrYZhYUDgesfl8jBMZhJTi6c5CkxqswtR13oiAV").constant("parseClientKey","knKQIUl70iAxbe3pX53eMpdw3mdoNNbmEH1bq2aF").constant("linkedInId","75xupinrki5ffj").constant("linkedInSecret","5CbgTHP9cdsomJIZ");var FACEBOOK_APP_ID="470904259739082";
//# sourceMappingURL=/maps/app.js.map